#!/bin/bash
#
# Copyright (c) 2010 Linagora
# Patrick Guiran <pguiran@linagora.com>
# http://github.com/Tauop/ScriptHelper
#
# ScriptHelper is free software, you can redistribute it and/or modify
# it under the terms of the GNU General Public License as
# published by the Free Software Foundation; either version 2 of
# the License, or (at your option) any later version.
#
# ScriptHelper is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#

# -f Disable pathname expansion.
# -u Unset variables
set -fu

# Load library ---------------------------------------------------------------
SCRIPT_HELPER_DIRECTORY='..'
[ -r /etc/ScriptHelper.conf ] && . /etc/ScriptHelper.conf

LOAD() {
  if [ -r "${SCRIPT_HELPER_DIRECTORY}/$1" ]; then
    . "${SCRIPT_HELPER_DIRECTORY}/$1"
  else
    printf '%s\n' "[ERROR] Unable to load $1"
    exit 1
  fi
}

LOAD message.lib.sh
LOAD ask.lib.sh
LOAD cli.lib.sh
LOAD cli-help.lib.sh
LOAD random.lib.sh

CLI_REGISTER_CODE_CACHE "/tmp/cli_test.code.$(RANDOM)"
CLI_REGISTER_HELP "/tmp/cli_test.help.$(RANDOM)"

CLI_SET_PROMPT "cli"
CLI_REGISTER_MENU    "msg" 'help message'
CLI_REGISTER_COMMAND "msg hello"   "printf 'hello\\\n'"
CLI_REGISTER_COMMAND "msg reply <what>" "printf '\1\\\n'"
CLI_REGISTER_COMMAND "ping <from> pong <target>[:<optional>]" "PING_PONG \2 \1" "Like to play ping-pong"

PING_PONG() { printf '%s\n' "$1 - $2"; }

input_file="/tmp/cli_test.in.$(RANDOM)"
output_file="/tmp/cli_test.out.$(RANDOM)"
expected_output_file="/tmp/cli_test.result_out.$(RANDOM)"

cat >"${input_file}" <<EOF
msg hello
msg
reply toto
prout
ping cat pong lol
quit
ping cat pong lol
ping cat pong lol:80
msg reply lol
help ping
quit
EOF

cat >"${expected_output_file}" <<EOF
cli >  msg hello
hello
cli >  msg
cli [msg]>  reply toto
toto
cli [msg]>  prout
ERROR: Unknown CLI command: prout
cli [msg]>  ping cat pong lol
ERROR: Unknown CLI command: ping cat pong lol
cli [msg]>  quit
cli >  ping cat pong lol
lol - cat
cli >  ping cat pong lol:80
lol:80 - cat
cli >  msg reply lol
lol
cli >  help ping
ping <from> pong <target>[:<optional>]	Like to play ping-pong
cli >  quit
EOF

ASK_SET_AUTOANSWER_FILE "${input_file}"

( CLI_RUN > "${output_file}" )
diff -au "${expected_output_file}" "${output_file}"
res=$?

find /tmp -maxdepth 1 -name "cli_test.*" -exec rm -f {} \;

if [ ${res} -eq 0 ]; then
  printf '\n*** All Tests OK ***\n'
  exit 0
else
  printf '\n[ERROR] Test failed\n'
  exit 1;
fi
